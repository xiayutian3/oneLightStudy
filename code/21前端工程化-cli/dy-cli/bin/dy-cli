#! /usr/bin/env node

const figlet = require('figlet'); //ç”Ÿæˆaskç 
const Printer = require('@darkobits/lolcatjs') //å­—ä½“å˜è‰²
const txt = figlet.textSync("hello world") + "\n" + "è‡ªå®šä¹‰è„šæ‰‹æ¶";
const prograrm = require('commander') //å¤„ç†ç”¨æˆ·è¾“å…¥çš„å‚æ•°
const inquirer = require('inquirer');//è·Ÿç”¨æˆ·è¿›è¡Œäº¤äº’
const chalk = require('chalk') //è·Ÿç”¨æˆ·è¯´è¯
const json2ts = require("json2ts"); //æ ¹æ®ç±»å‹ç”Ÿæˆ interfaceæ¥å£
const ora = require('ora'); //å°loading
const shell = require('shelljs'); //js å†™linuxå‘½ä»¤
// console.log(shell.pwd().stdout) //è·¯å¾„
const download = require("download-git-repo") //ä¸‹è½½gitä»“åº“
const templateUrl = `direct:https://github.com/xiayutian3/diy-vue-cli.git` //ä¸‹è½½gitä»“åº“ url

// const result = Printer.default.fromString(txt)

prograrm.version(Printer.default.fromString(txt), "-v,--version");
prograrm.option("init", "åˆå§‹åŒ–é¡¹ç›®");
prograrm.option("json2ts", "å°†æ¥å£ç”Ÿæˆinterface ts");

const bindHandler = {
  init() {
    // console.log("è¿›å…¥ç”¨æˆ·çš„åˆå§‹åŒ–ç¨‹åº")
    inquirer
      .prompt([
        {
          type:'text',
          message:"è¯·è¾“å…¥æ–‡ä»¶å¤¹çš„åç§°",
          name:"dirname"
        },
        {
          type: "list",
          name: 'jskind',
          message: "è¯·é€‰æ‹©ä½¿ç”¨çš„è¯­è¨€",
          choices: ["ES6", "TypeScript"]
        }
      ])
      .then(answers => {
        // Use user feedback for... whatever!!
        // 1.gitå‡†å¤‡å¼€å‘å¥½ä¸€ä¸ªèƒ½å®¹çº³ç™¾å·çš„é¡¹ç›®
        // 2.git ä¸‹è½½é‚£ä¸ªåŒ…
        // 3.shelljs æ ¹æ®ç”¨æˆ·é€‰æ‹©å¯¹ä½ çš„ä¸‹è½½çš„åŒ…ç»è¡Œä¿®æ”¹åˆ é™¤
        // 4.åœ¨ç”¨æˆ·çš„æ¡Œé¢åˆ›å»ºæœ€ç»ˆçš„é¡¹ç›®
        // 5.å¼•å¯¼å¼€å‘ä½¿ç”¨
        const __dirname = answers.dirname //æ–‡ä»¶å¤¹åç§°
        console.log("ğŸš€__dirname", __dirname)
        if(__dirname){
          const spinner = ora('download template...')
          spinner.start();
          const _pwd= shell.pwd().stdout; //è·å–å‘½ä»¤æ‰€åœ¨çš„æ–‡ä»¶å¤¹è·¯å¾„
          console.log(_pwd)
          const _projectPath = `${_pwd}/${__dirname}` //é¡¹ç›®è·¯å¾„  //F:\study\oneLightStudy\code\21å‰ç«¯å·¥ç¨‹åŒ–-cli\dy-cli
          shell.cd(_pwd) //è¿›å…¥ç›®å½•
          shell.rm("-rf" , _projectPath) //åˆ é™¤å·²å­˜åœ¨çš„åŒåæ–‡ä»¶å¤¹
          shell.mkdir(__dirname) //åˆ›å»ºæ–‡ä»¶å¤¹
          //ä¸‹è½½æ¨¡æ¿
          download(templateUrl,_projectPath,{ clone: true },(err)=>{
            spinner.stop();//å…³æ‰loading
            if(err){
              // console.error("ä¸‹è½½å¤±è´¥"+err.message)
              console.log(chalk.red('ä¸‹è½½å¼‚å¸¸'+err.message))
            }else{
              //ä¿®æ”¹æ¨¡æ¿ packjson åŒ…å
              shell.sed("-i","vuediy3",__dirname,_projectPath+'/package.json')
            }
          })
        }
      })
  },
  json2ts(jsonurl) {
    const spinner = ora('æ¥å£æ­£åœ¨ç”Ÿæˆä¸­...')
    spinner.start();
    console.log("æ¥å£åœ°å€", jsonurl)
    const jsonContent = {
      code: 1,
      info: {
        message: "è¯·æ±‚æˆåŠŸ",
        data: [
          {
            num: 1,
            title: "ç‹å¤§å…‰ç¯¡æ”¹"
          }
        ]
      }
    }
    let result = json2ts.convert(JSON.stringify(jsonContent));
    console.log(result) //interfaceæ¥å£
    setTimeout(() => {
      spinner.stop(); //å…³æ‰loading
    }, 1000)

  }
}
prograrm.usage("<cmd> [env]")
  .arguments("<cmd> [env]")
  .action(function (cmd, otherParams) {
    // console.log(cmd)
    const handler = bindHandler[cmd]
    if (handler) {
      handler(otherParams)
    } else {
      // console.log("æš‚æœªå®ç° "+cmd)
      console.log(chalk.yellow("éå¸¸é—æ†¾ï¼š") + "ã€" + chalk.red(cmd) + "ã€‘" + chalk.yellow("æ²¡æœ‰å®ç°"))
    }

  })
prograrm.parse(process.argv);
// console.log(result);